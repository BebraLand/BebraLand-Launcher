name: Build BebraLand Launcher

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  # pull_request:
  #   branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: write

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/Gml.Launcher/Gml.Launcher.csproj'
  CONFIGURATION: 'Release'

jobs:
  build-windows:
    name: Build Windows (${{ matrix.runtime }})
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        runtime: 
          - win-x86
          - win-x64
          - win-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Disable Windows Defender
      run: |
        Set-MpPreference -DisableRealtimeMonitoring $true
      shell: powershell
      continue-on-error: true
    
    - name: Restore dependencies with retry
      shell: bash
      run: |
        max_attempts=3
        attempt=0
        until [ $attempt -ge $max_attempts ]
        do
          dotnet restore ${{ env.PROJECT_PATH }} && break
          attempt=$((attempt+1))
          echo "Restore attempt $attempt failed. Retrying in 10 seconds..."
          sleep 10
        done
        if [ $attempt -ge $max_attempts ]; then
          echo "Restore failed after $max_attempts attempts"
          exit 1
        fi
    
    - name: Build project
      shell: bash
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration ${{ env.CONFIGURATION }} \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          --no-restore \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -p:EnableCompressionInSingleFile=true \
          -p:DebugType=None \
          -p:DebugSymbols=false
    
    - name: Create archive
      shell: bash
      run: |
        cd ./publish/${{ matrix.runtime }}
        if [ "${{ matrix.runtime }}" == "win-x86" ] || [ "${{ matrix.runtime }}" == "win-x64" ] || [ "${{ matrix.runtime }}" == "win-arm64" ]; then
          7z a -tzip ../../Gml.Launcher-${{ matrix.runtime }}.zip *
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Gml.Launcher-${{ matrix.runtime }}
        path: ./publish/${{ matrix.runtime }}
        retention-days: 30
    
    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.runtime }}
        path: ./Gml.Launcher-${{ matrix.runtime }}.zip
        retention-days: 7

  build-linux:
    name: Build Linux (${{ matrix.runtime }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        runtime:
          - linux-x64
          - linux-musl-x64
          - linux-arm
          - linux-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
    
    - name: Build project
      shell: bash
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration ${{ env.CONFIGURATION }} \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          --no-restore \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -p:EnableCompressionInSingleFile=true \
          -p:DebugType=None \
          -p:DebugSymbols=false
    
    - name: Create archive
      shell: bash
      run: |
        cd ./publish/${{ matrix.runtime }}
        tar -czf ../../Gml.Launcher-${{ matrix.runtime }}.tar.gz *
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Gml.Launcher-${{ matrix.runtime }}
        path: ./publish/${{ matrix.runtime }}
        retention-days: 30
    
    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.runtime }}
        path: ./Gml.Launcher-${{ matrix.runtime }}.tar.gz
        retention-days: 7

  build-macos:
    name: Build macOS (${{ matrix.runtime }})
    runs-on: macos-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        runtime:
          - osx-x64
          - osx-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
    
    - name: Build project
      shell: bash
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration ${{ env.CONFIGURATION }} \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          --no-restore \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -p:EnableCompressionInSingleFile=true \
          -p:DebugType=None \
          -p:DebugSymbols=false
    
    - name: Create archive
      shell: bash
      run: |
        cd ./publish/${{ matrix.runtime }}
        tar -czf ../../Gml.Launcher-${{ matrix.runtime }}.tar.gz *
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Gml.Launcher-${{ matrix.runtime }}
        path: ./publish/${{ matrix.runtime }}
        retention-days: 30
    
    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.runtime }}
        path: ./Gml.Launcher-${{ matrix.runtime }}.tar.gz
        retention-days: 7

  release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all release artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: release-*
        path: ./release-artifacts
        merge-multiple: true
    
    - name: Display artifact structure
      run: ls -lah ./release-artifacts
    
    - name: Extract version from tag or generate from commit
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=build-${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: BebraLand Launcher ${{ steps.get_version.outputs.VERSION }}
        files: ./release-artifacts/*
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || !startsWith(github.ref, 'refs/tags/') }}
        generate_release_notes: true
        body: |
          ## BebraLand Launcher ${{ steps.get_version.outputs.VERSION }}
          
          ### Downloads
          
          #### Windows
          - **win-x64**: For 64-bit Windows systems
          - **win-x86**: For 32-bit Windows systems  
          - **win-arm64**: For ARM64 Windows systems
          
          #### Linux
          - **linux-x64**: For standard 64-bit Linux distributions
          - **linux-musl-x64**: For Alpine Linux and other musl-based distributions
          - **linux-arm**: For 32-bit ARM Linux systems
          - **linux-arm64**: For 64-bit ARM Linux systems (Raspberry Pi, etc.)
          
          #### macOS
          - **osx-x64**: For Intel-based Macs
          - **osx-arm64**: For Apple Silicon Macs (M1, M2, M3)
          
          ### Installation
          1. Download the appropriate archive for your platform
          2. Extract the archive
          3. Run the launcher executable
          
          **Note**: All builds are self-contained and don't require .NET runtime installation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}